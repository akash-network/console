name: Release app
on:
  push:
    branches: ["main"]
    paths:
      - "apps/**/*"
      - "packages/**/*"
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: read
  checks: read
  actions: write

jobs:
  setup:
    runs-on: ubuntu-latest
    outputs:
      backends: ${{ steps.matrix.outputs.backends }}
      nextjs: ${{ steps.matrix.outputs.nextjs }}
    steps:
      - uses: actions/checkout@v6
      - name: Detect changed apps
        id: matrix
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        # shellcheck disable=SC2016
        run: |
          if [[ "${GITHUB_EVENT_NAME}" != "workflow_dispatch" ]]; then
            gh api "repos/$GITHUB_REPOSITORY/commits/$GITHUB_SHA" --jq '[.files[].filename]' > changed_files.json
          fi
          node --input-type=module -e '
            import fs from "fs";
            import { findLocalPackageDependencies } from "./packages/releaser/find-local-package-dependencies.js";

            // trigger release for all in case of workflow_dispatch, otherwise only for changed apps
            const changedFiles = process.env.GITHUB_EVENT_NAME === "workflow_dispatch"
              ? fs.readdirSync("./apps").map(app => "apps/" + app + "/")
              : JSON.parse(fs.readFileSync("./changed_files.json", "utf-8"));

            // App to deploy workflow mapping
            const APP_ALIASES = {
              "api": "console-api",
              "deploy-web": "console-web",
            };
            const workflowFile = (app) => (APP_ALIASES[app] || app) + "-release.yml";
            const appsToRelease = fs.readdirSync("./apps").filter(app => {
              const appPath = "apps/" + app;
              const localDependencies = findLocalPackageDependencies(appPath);
              return changedFiles.some(f => f.startsWith(appPath + "/") || localDependencies.some(dep => f.startsWith(dep + "/")));
            });

            const nextjs = appsToRelease
              .filter(a => fs.readdirSync("apps/" + a).some(f => f.startsWith("next.config")))
              .map(a => ({ app: a, deploy_workflow: workflowFile(a) }));
            const backends = appsToRelease
              .filter(a => !nextjs.some(n => n.app === a) && a !== "log-collector")
              .map(a => ({ app: a, deploy_workflow: workflowFile(a) }));

            console.log("nextjs=" + JSON.stringify({ include: nextjs }));
            console.log("backends=" + JSON.stringify({ include: backends }));
          ' >> "$GITHUB_OUTPUT"

  release-backends:
    needs: setup
    if: fromJson(needs.setup.outputs.backends).include[0]
    strategy:
      matrix: ${{ fromJson(needs.setup.outputs.backends) }}
    uses: ./.github/workflows/reusable-release-app.yml
    secrets: inherit
    permissions:
      contents: write
      packages: write
      actions: write
    with:
      app: ${{ matrix.app }}
      deploy_workflow: ${{ matrix.deploy_workflow }}

  release-nextjs:
    needs: setup
    if: fromJson(needs.setup.outputs.nextjs).include[0]
    strategy:
      matrix: ${{ fromJson(needs.setup.outputs.nextjs) }}
    uses: ./.github/workflows/reusable-release-nextjs-app.yml
    secrets: inherit
    permissions:
      contents: write
      packages: write
      actions: write
    with:
      app: ${{ matrix.app }}
      deploy_workflow: ${{ matrix.deploy_workflow }}
