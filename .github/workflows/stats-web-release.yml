name: Release Deploy Web

on:
  push:
    branches:
      - main
    paths:
      - "apps/stats-web/package.json"

jobs:
  release:
    name: Create Release
    uses: ./.github/workflows/reusable-create-github-release.yml
    secrets: inherit
    with:
      app: stats-web

  build-beta:
    needs: release
    name: Build Beta Docker image
    permissions:
      contents: write
      packages: write
    outputs:
      base_image_tag: ${{ steps.build.outputs.version }}
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/build-image
        id: build
        with:
          app: stats-web
          container-registry: ${{ vars.STATS_WEB_REGISTRY }}
          tag: ${{ needs.release.outputs.git_tag }}-beta
          github-token: ${{ secrets.GITHUB_TOKEN }}
          deployment-env: staging

  build-prod:
    needs: release
    name: Build Prod Docker image
    permissions:
      contents: write
      packages: write
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/build-image
        with:
          app: stats-web
          container-registry: ${{ vars.STATS_WEB_REGISTRY }}
          tag: ${{ needs.release.outputs.git_tag }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
          deployment-env: production
