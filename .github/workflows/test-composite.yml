name: test composite
on:
  workflow_dispatch:
    inputs:
      app:
        description: "App to deploy (e.g., indexer, stats-web, notifications, tx-signer)"
        required: true
        type: string
      appVersion:
        description: "App version to deploy (e.g., latest, 1.0.0, v1.0.0)"
        required: true
        type: string

  push:

jobs:
  # smoke:
  #   runs-on: ubuntu-latest
  #   steps:
  #     - uses: actions/checkout@v6
  #       with:
  #         sparse-checkout: |
  #           .github
  #     - uses: ./.github/actions/poll-check-status
  #       with:
  #         name: "security/snyk (corysturtevant)"
  #         sha: d21fecbfc4bab7f6154f2c26824677f7ba00b2cc
  #         check_type: status
  #         # accept neutral here because this check may fail due to Free tier limits
  #         expected_conclusions: "success;neutral"

  # test:
  #   uses: ./.github/workflows/reusable-create-github-release.yml
  #   secrets: inherit
  #   with:
  #     app: indexer

  # test-e2e:
  #   permissions:
  #     contents: read
  #     pull-requests: read
  #   # needs: deploy-prod-mainnet
  #   name: Test prod mainnet
  #   uses: ./.github/workflows/reusable-test-e2e.yml
  #   secrets: inherit
  #   with:
  #     app: provider-proxy
  #     app-url: https://console.akash.network/provider-proxy-mainnet
  #     environment: production
  #     chain: mainnet
  #     env: >-
  #       {
  #         "CONSOLE_API_BASE_URL": "https://console.akash.network/api-mainnet"
  #       }
  check-whether-to-approve:
    permissions:
      contents: read
      pull-requests: write
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
        with:
          sparse-checkout: |
            ./.github/actions
      - name: Get associated PR
        id: associated-pr
        uses: ./.github/actions/associated-pr
        with:
          sha: 17b3df0d83a3ef96f5c0d88720fbc0721153800e
      - name: Evaluate auto-approval criteria
        id: evaluate
        if: steps.associated-pr.outputs.number != ''
        uses: actions/github-script@v7
        env:
          PR_NUMBER: ${{ steps.associated-pr.outputs.number }}
          PR_TITLE: ${{ steps.associated-pr.outputs.title }}
          PR_LABELS: ${{ steps.associated-pr.outputs.labels }}
          PR_AUTHOR: ${{ steps.associated-pr.outputs.author }}
          PR_HEAD_REPO: ${{ steps.associated-pr.outputs.head_repo }}
        with:
          script: |
            const prNumber = parseInt(process.env.PR_NUMBER || "");
            const baseRepo = `${context.repo.owner}/${context.repo.repo}`;
            const headRepo = process.env.PR_HEAD_REPO ?? "";
            if (headRepo && headRepo !== baseRepo) {
              core.info("Skipping: PR is from a fork");
              return;
            }

            const login = process.env.PR_AUTHOR ?? "";
            if (/bot/i.test(login)) {
              core.info(`Skipping: author "${login}" appears to be a bot`);
              return;
            }

            const labels = (process.env.PR_LABELS ?? "").split(",").filter(Boolean);
            core.info(`PR labels: ${labels.join(", ")}`);

            if (!labels.includes("experienced-contributor")) {
              core.info("Skipping: missing experienced-contributor label");
              return;
            }

            const allowedSizes = ["size: XS", "size: S", "size: M"];
            if (!allowedSizes.some(size => labels.includes(size))) {
              core.info("Skipping: missing required size label (XS, S, or M)");
              return;
            }

            const title = process.env.PR_TITLE ?? "";
            const isChore = title.startsWith("chore:") || title.startsWith("chore(");
            const isTest = title.startsWith("test:") || title.startsWith("test(");
            const isDocs = title.startsWith("docs:") || title.startsWith("docs(");

            if (!isChore && !isTest && !isDocs) {
              core.info(`Skipping: commit is not one of these types: chore, test, or docs`);
              return;
            }

            const files = await github.paginate(github.rest.pulls.listFiles, {
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber,
              per_page: 100,
            });
            const filenames = files.map(f => f.filename);

            if (isTest) {
              const testFilePattern = /(\.(spec|integration)\.(ts|tsx)$|\/tests?\/)|(jest|vitest)\.config\.[tj]s$/;
              const onlyTestFiles = filenames.every(f => testFilePattern.test(f));
              if (!onlyTestFiles) {
                core.info("Skipping test: PR changes non-test files");
                return;
              }
            }

            if (isDocs) {
              const imagePattern = /\.(png|jpg|jpeg|gif|svg|webp|ico|bmp)$/i;
              const docsFilePattern = f => f.endsWith(".md") || imagePattern.test(f);
              const onlyDocFiles = filenames.every(docsFilePattern);
              if (!onlyDocFiles) {
                core.info("Skipping docs: PR changes non-documentation files");
                return;
              }
            }

            if (isChore) {
              const sourceCodeFile = /\.(ts|tsx|js|jsx)$/;
              const touchesCode = filenames.some(f => {
                return sourceCodeFile.test(f) && (f.includes("/packages/") || f.includes("/apps/"));
              });
              if (touchesCode) {
                core.info("Skipping chore: PR touches code files in packages/ or apps/");
                return;
              }
            }

            core.setOutput("can-approve", "true");
            core.info(`PR #${prNumber} meets auto-approval criteria`);
      - name: Approve PR
        if: steps.evaluate.outputs.can-approve == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ steps.associated-pr.outputs.number }}
          REPO: ${{ github.repository }}
        run: |
          gh pr review "$PR_NUMBER" -R "$REPO" --approve --body "Auto-approved: meets auto-approval criteria."
