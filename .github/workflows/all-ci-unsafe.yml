# Security scan workflow triggered after CI completes successfully.
# Uses workflow_run to run in base repo context, giving access to secrets for fork PRs.
#
# !!!! PLEASE be extra careful here and treat forked repository as untrusted user input !!!!

name: Security Scan

on:
  workflow_run:
    workflows: ["CI"]
    types: [completed]

concurrency:
  group: ${{ github.workflow }}-${{ github.event.workflow_run.head_branch }}
  cancel-in-progress: true

permissions:
  contents: read
  pull-requests: read
  checks: write # to create check run on related PR

jobs:
  create-check-run:
    runs-on: ubuntu-latest
    outputs:
      run_scan: ${{ steps.decide.outputs.run_scan }}
      check_run_id: ${{ steps.create_check.outputs.check_run_id }}
      skip_reason: ${{ steps.decide.outputs.skip_reason }}
    steps:
      - name: Decide whether to run scan
        id: decide
        run: |
          # If upstream CI failed, we must report failure (required check)
          if [ "${{ github.event.workflow_run.conclusion }}" != "success" ]; then
            echo "run_scan=false" >> "$GITHUB_OUTPUT"
            echo "skip_reason=Upstream CI conclusion is '${{ github.event.workflow_run.conclusion }}'" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          # workflow_run.event is the triggering event of the upstream workflow (e.g. pull_request)
          if [ "${{ github.event.workflow_run.event }}" != "pull_request" ]; then
            echo "run_scan=false" >> "$GITHUB_OUTPUT"
            echo "skip_reason=Upstream CI was not triggered by pull_request (event=${{ github.event.workflow_run.event }})" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "run_scan=true" >> "$GITHUB_OUTPUT"
          echo "skip_reason=" >> "$GITHUB_OUTPUT"

      - name: Create check run
        id: create_check
        uses: actions/github-script@v7
        with:
          script: |
            const sha = context.payload.workflow_run.head_sha;
            const res = await github.rest.checks.create({
              name: "security-scan",
              owner: context.repo.owner,
              repo: context.repo.repo,
              head_sha: sha,
              status: "in_progress",
              output: {
                title: "Security scan",
                summary: "Initializing..."
              }
            });

            core.setOutput("check_run_id", String(res.data.id));

      - name: Early-complete check as success when not running scan
        if: ${{ steps.decide.outputs.run_scan != 'true' }}
        uses: actions/github-script@v7
        env:
          CHECK_RUN_ID: ${{ steps.create_check.outputs.check_run_id }}
          SKIP_REASON: ${{ steps.decide.outputs.skip_reason }}
          RELATED_WORKFLOW_CONCLUSION: ${{ github.event.workflow_run.conclusion }}
        with:
          script: |
            const sha = context.payload.workflow_run.head_sha;
            const checkRunId = Number(process.env.CHECK_RUN_ID);
            const conclusion = process.env.RELATED_WORKFLOW_CONCLUSION === 'success' ? 'success' : 'failure';
            const summary = process.env.RELATED_WORKFLOW_CONCLUSION === 'success'
              ? `Skipped (treated as pass)`
              : `Blocked`;

            await github.rest.checks.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              check_run_id: checkRunId,
              head_sha: sha,
              status: "completed",
              conclusion,
              output: {
                title: "Security scan",
                summary: `${summary}: ${process.env.SKIP_REASON}`
              }
            });

  setup:
    needs: [create-check-run]
    if: ${{ needs.create-check-run.outputs.run_scan == 'true' }}
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.matrix.outputs.value }}
      should_run: ${{ steps.check_label.outputs.should_run }}
      skip_reason: ${{ steps.check_label.outputs.skip_reason }}
      pr_head_ref: ${{ steps.associated_pr.outputs.head_ref }}
      pr_head_repo: ${{ steps.associated_pr.outputs.head_repo }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Get associated PR
        id: associated_pr
        uses: ./.github/actions/associated-pr
        with:
          sha: ${{ github.event.workflow_run.head_sha }}

      - name: Check for skip label
        id: check_label
        env:
          PR_NUMBER: ${{ steps.associated_pr.outputs.number }}
          PR_LABELS: ${{ steps.associated_pr.outputs.labels }}
        run: |
          if [[ -z "$PR_NUMBER" ]]; then
            echo "should_run=false" >> "$GITHUB_OUTPUT"
            echo "skip_reason=No PR found for commit" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          if echo "$PR_LABELS" | grep -q "ignore-static-security-analysis"; then
            echo "should_run=false" >> "$GITHUB_OUTPUT"
            echo "skip_reason=Label 'ignore-static-security-analysis' is present" >> "$GITHUB_OUTPUT"
          else
            echo "should_run=true" >> "$GITHUB_OUTPUT"
            echo "skip_reason=" >> "$GITHUB_OUTPUT"
          fi

      - name: Build matrix from changed files
        if: steps.check_label.outputs.should_run == 'true'
        id: matrix
        env:
          GH_TOKEN: ${{ github.token }}
          PR_NUMBER: ${{ steps.associated_pr.outputs.number }}
        run: |
          changed_files=$(gh api "/repos/${{ github.repository }}/pulls/$PR_NUMBER/files" \
            --paginate --jq '.[].filename')

          all_apps=$(find apps/* -maxdepth 0 -type d -print0 | xargs -0 -n1 basename)

          changed_apps=()
          for app in $all_apps; do
            if echo "$changed_files" | grep -q "^apps/$app/"; then
              changed_apps+=("$app")
            fi
          done

          if [ ${#changed_apps[@]} -eq 0 ]; then
            echo "value=" >> "$GITHUB_OUTPUT"
          else
            workspaces=$(printf '"%s",' "${changed_apps[@]}")
            workspaces="[${workspaces%,}]"
            echo 'value={"workspace":'"$workspaces"'}' >> "$GITHUB_OUTPUT"
          fi

  security-scan:
    needs: [setup]
    if: ${{ needs.setup.outputs.should_run == 'true' && needs.setup.outputs.matrix != '' }}
    strategy:
      matrix: ${{ fromJson(needs.setup.outputs.matrix) }}
      fail-fast: false
    uses: ./.github/workflows/reusable-validate-app-unsafe.yml
    secrets:
      gh-token: ${{ secrets.GITHUB_TOKEN }}
      snyk-token: ${{ secrets.SNYK_TOKEN }}
    with:
      path: apps/${{ matrix.workspace }}
      pr_head_ref: ${{ needs.setup.outputs.pr_head_ref }}
      pr_head_repo: ${{ needs.setup.outputs.pr_head_repo }}
      skip_change_detection: true

  apps-deps-scan:
    needs: [setup]
    if: ${{ needs.setup.outputs.should_run == 'true' }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          sparse-checkout: |
            .github

      - name: Check snyk status
        uses: ./.github/actions/poll-check-status
        with:
          name: "security/snyk (corysturtevant)"
          sha: ${{ github.event.workflow_run.head_sha }}
          check_type: status
          expected_conclusions: "success;neutral"

      - name: Check socketio status
        uses: ./.github/actions/poll-check-status
        with:
          name: "Socket Security: Pull Request Alerts"
          sha: ${{ github.event.workflow_run.head_sha }}
          expected_conclusions: "success;neutral"

  finalize:
    runs-on: ubuntu-latest
    needs: [create-check-run, setup, security-scan, apps-deps-scan]
    if: ${{ always() && needs.create-check-run.outputs.run_scan == 'true' }}
    steps:
      - name: Decide final conclusion and summary
        id: final
        env:
          SETUP_SHOULD_RUN: ${{ needs.setup.outputs.should_run }}
          SETUP_SKIP_REASON: ${{ needs.setup.outputs.skip_reason }}
          MATRIX: ${{ needs.setup.outputs.matrix }}
          SCAN_RESULT: ${{ needs.security-scan.result }}
          APPS_DEPS_SCAN_RESULT: ${{ needs.apps-deps-scan.result }}
        run: |
          conclusion="success"
          summary="Security scan passed."

          if [[ "$SETUP_SHOULD_RUN" != "true" ]]; then
            conclusion="success"
            summary="Skipped (treated as pass): $SETUP_SKIP_REASON"
          elif [[ -z "$MATRIX" ]]; then
            conclusion="success"
            summary="Skipped (treated as pass): No apps changed in this PR"
          elif [[ "$SCAN_RESULT" != "success" ]]; then
            conclusion="failure"
            summary="Security scan failed (result=$SCAN_RESULT)"
          elif [[ "$APPS_DEPS_SCAN_RESULT" != "success" ]]; then
            conclusion="failure"
            summary="Apps dependencies scan failed (result=$APPS_DEPS_SCAN_RESULT)"
          fi

          echo "conclusion=$conclusion" >> "$GITHUB_OUTPUT"
          echo "summary=$summary" >> "$GITHUB_OUTPUT"

      - name: Complete check run
        uses: actions/github-script@v7
        env:
          CHECK_RUN_ID: ${{ needs.create-check-run.outputs.check_run_id }}
          CONCLUSION: ${{ steps.final.outputs.conclusion }}
          SUMMARY: ${{ steps.final.outputs.summary }}
        with:
          script: |
            const sha = context.payload.workflow_run.head_sha;
            const checkRunId = Number(process.env.CHECK_RUN_ID);

            await github.rest.checks.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              check_run_id: checkRunId,
              head_sha: sha,
              status: "completed",
              conclusion: process.env.CONCLUSION,
              output: {
                title: "Security scan",
                summary: process.env.SUMMARY
              }
            });
