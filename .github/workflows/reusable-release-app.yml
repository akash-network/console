name: Release Backend App

on:
  workflow_call:
    inputs:
      app:
        description: "The app to release (directory name in ./apps/*)"
        required: true
        type: string
      deploy_workflow:
        description: "Deployment workflow filename (e.g., console-api-release.yml)"
        required: false
        type: string
    outputs:
      git_tag:
        description: "The git tag released"
        value: ${{ jobs.release.outputs.git_tag }}
      image_tag:
        description: "The Docker image tag"
        value: ${{ jobs.build.outputs.image_tag }}

jobs:
  release:
    name: Create Release
    uses: ./.github/workflows/reusable-create-github-release.yml
    secrets: inherit
    permissions:
      contents: write
    with:
      app: ${{ inputs.app }}

  build:
    needs: release
    name: Build Docker image
    if: needs.release.outputs.git_tag != ''
    uses: ./.github/workflows/reusable-build-image.yml
    secrets: inherit
    permissions:
      contents: write
      packages: write
    with:
      tag: ${{ needs.release.outputs.git_tag }}

  deploy:
    needs: [release, build]
    if: needs.release.outputs.git_tag != '' && inputs.deploy_workflow != ''
    runs-on: ubuntu-latest
    permissions:
      actions: write
    steps:
      - name: Trigger deployment
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh workflow run ${{ inputs.deploy_workflow }} \
            --repo ${{ github.repository }} \
            --ref ${{ needs.release.outputs.git_tag }} \
