name: Deploy Setup

on:
  workflow_call:
    inputs:
      image_tag:
        description: "Full image tag (e.g., console-api/latest, console-api/1.0.0, console-api/v1.0.0)"
        required: true
        type: string
      app:
        description: "Application name (e.g., console-api, tx-signer)"
        required: true
        type: string
    outputs:
      image_tag:
        description: "Resolved image tag to deploy"
        value: ${{ jobs.setup.outputs.image_tag }}

permissions:
  contents: read

jobs:
  setup:
    runs-on: ubuntu-latest
    outputs:
      image_tag: ${{ steps.extract.outputs.image_tag }}
    steps:
      - id: extract
        env:
          GH_TOKEN: ${{ github.token }}
          TAG_NAME: ${{ inputs.image_tag }}
          APP: ${{ inputs.app }}
        run: |
          if [[ "$TAG_NAME" == "latest" ]]; then
            TAG_NAME=$(gh api "repos/${{ github.repository }}/releases/latest" --jq '.tag_name')
          fi

          package_name="${TAG_NAME%%/*}"
          version="${TAG_NAME#*/}"

          if [[ "$TAG_NAME" = v* ]] || [[ "$TAG_NAME" = [0-9]* ]] || [[ "$package_name" = "$APP" ]]; then
            echo "✅ Deployment tag is valid."
          else
            echo "❌ This deployment workflow (app=$APP) can be started from $APP/v* tags or from specific version (e.g., v1.2.3, 1.2.3)."
            echo "You started it from: $TAG_NAME"
            exit 1
          fi

          # Remove 'v' prefix if present
          version="${version#v}"

          # Remove beta suffix if present
          version="${version%-beta}"

          echo "image_tag=$version" >> "$GITHUB_OUTPUT"
