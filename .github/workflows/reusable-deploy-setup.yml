name: Deploy Setup

on:
  workflow_call:
    inputs:
      image_tag:
        description: "Full image tag (e.g., console-api/latest, console-api/1.0.0, console-api/v1.0.0)"
        required: true
        type: string
      app:
        description: "Application name (e.g., console-api, tx-signer)"
        required: true
        type: string
      cancel-if-stale:
        description: "Whether to cancel this deployment if a newer version is already queued, running, or recently deployed"
        required: false
        type: boolean
        default: false
    outputs:
      image_tag:
        description: "Resolved image tag to deploy"
        value: ${{ jobs.setup.outputs.image_tag }}
      skip:
        description: "Set to 'true' if deployment should be skipped (a newer version is already in flight)"
        value: ${{ jobs.setup.outputs.skip }}

permissions:
  contents: read
  actions: read

jobs:
  setup:
    runs-on: ubuntu-latest
    outputs:
      image_tag: ${{ steps.extract.outputs.image_tag }}
      skip: ${{ steps.stale-guard.outputs.skip }}
    steps:
      - name: Extract and Validate Image Tag
        id: extract
        env:
          GH_TOKEN: ${{ github.token }}
          TAG_NAME: ${{ inputs.image_tag }}
          APP: ${{ inputs.app }}
        run: |
          if [[ "$TAG_NAME" == "latest" ]]; then
            TAG_NAME=$(gh api "repos/${{ github.repository }}/releases/latest" --jq '.tag_name')
          fi

          package_name="${TAG_NAME%%/*}"
          version="${TAG_NAME#*/}"

          if [[ "$TAG_NAME" = v* ]] || [[ "$TAG_NAME" = [0-9]* ]] || [[ "$package_name" = "$APP" ]]; then
            echo "✅ Deployment tag is valid."
          else
            echo "❌ This deployment workflow (app=$APP) can be started from $APP/v* tags or from specific version (e.g., v1.2.3, 1.2.3)."
            echo "You started it from: $TAG_NAME"
            exit 1
          fi

          # Remove 'v' prefix if present
          version="${version#v}"

          # Remove beta suffix if present
          version="${version%-beta}"

          echo "image_tag=$version" >> "$GITHUB_OUTPUT"

      - name: Concurrency guard against old versions
        id: stale-guard
        if: ${{ steps.extract.outputs.image_tag != '' && inputs.cancel-if-stale }}
        uses: actions/github-script@v7
        with:
          script: |
            const version = '${{ steps.extract.outputs.image_tag }}';
            const app = '${{ inputs.app }}';

            const { data: currentRun } = await github.rest.actions.getWorkflowRun({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: context.runId
            });

            const parseVersion = v => v.split('.').map(n => parseInt(n, 10) || 0);
            const isNewer = (a, b) => {
              const pa = parseVersion(a), pb = parseVersion(b);
              for (let i = 0; i < Math.max(pa.length, pb.length); i++) {
                const diff = (pa[i] || 0) - (pb[i] || 0);
                if (diff !== 0) return diff > 0;
              }
              return false;
            };

            for (const status of ['queued', 'in_progress', 'completed']) {
              const { data } = await github.rest.actions.listWorkflowRuns({
                owner: context.repo.owner,
                repo: context.repo.repo,
                workflow_id: currentRun.workflow_id,
                status,
                per_page: 20
              });

              for (const run of data.workflow_runs) {
                if (run.id === context.runId) continue;
                if (status === 'completed' && run.conclusion !== 'success') continue;

                const otherImageTag = run.inputs?.image_tag;
                if (!otherImageTag) continue;

                const parts = otherImageTag.split('/', 2);
                const otherApp = parts.length === 2 ? parts[0] : app;
                const otherRawVersion = parts.length === 2 ? parts[1] : parts[0];
                if (otherApp !== app || !otherRawVersion) continue;

                const otherVersion = otherRawVersion?.replace(/^v/, '').replace(/-beta$/, '');

                if (isNewer(otherVersion, version)) {
                  core.warning(`Skipping ${app}@${version}: found newer ${otherVersion} (status: ${status})`);
                  core.setOutput('skip', 'true');
                  return;
                }
              }
            }
